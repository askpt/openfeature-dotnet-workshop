@page "/"
@using Garage.ServiceDefaults.Services
@using Garage.Shared.Models
@using Garage.Web.Services
@inject WinnersApiClient WinnersApi
@inject ILogger<Home> Logger
@inject IFeatureFlags FeatureFlags
@inject IJSRuntime JsRuntime
@rendermode InteractiveServer

<PageTitle>Le Mans Collection Tracker</PageTitle>

@if (ShowHeader)
{
    <div class="garage-header">
        <div class="header-top">
            <div class="title-section">
                <span class="garage-icon">🏆</span>
                <h1>Le Mans Collection Tracker</h1>
                <p class="subtitle">Track your model car winners collection of racing legends from the 24h of Le Mans</p>
            </div>
            <div class="stats-section">
                <div class="stat-item owned">
                    <span class="stat-number">@OwnedCount</span>
                    <span class="stat-label">Owned</span>
                </div>
                <div class="stat-item owned">
                    <span class="stat-number">@_winners.Count</span>
                    <span class="stat-label">Total</span>
                </div>
                <div class="stat-item complete">
                    <span class="stat-number">@(_winners.Count > 0
                                                      ? Math.Round((double)OwnedCount / _winners.Count * 100, 1)
                                                      : 0)%</span>
                    <span class="stat-label">Complete</span>
                </div>
            </div>
        </div>
    </div>
}

<div class="collection-summary">
    <span class="collection-count">@_winners.Count of @_winners.Count cars</span>
</div>

    <div class="collection-tabs">
        <button class="tab-btn @(_activeFilter == FilterType.All ? "active" : "")"
                @onclick="() => SetFilter(FilterType.All)">All Winners (@_winners.Count)
        </button>
        <button class="tab-btn @(_activeFilter == FilterType.Owned ? "active" : "")"
                @onclick="() => SetFilter(FilterType.Owned)">Owned (@OwnedCount)
        </button>
        <button class="tab-btn @(_activeFilter == FilterType.NotOwned ? "active" : "")"
                @onclick="() => SetFilter(FilterType.NotOwned)">Not Owned (@(_winners.Count - OwnedCount))
        </button>
    </div>
}

<div class="car-grid">
    @foreach (var winner in FilteredWinners)
    {
        <CarCard Car="@winner" OnOwnershipChanged="OnOwnershipChanged"/>
    }
</div>

@code {
    private List<Winner> _winners = [];
    private FilterType _activeFilter = FilterType.All;

    private int OwnedCount => _winners.Count(c => c.IsOwned);
    private bool ShowHeader => FeatureFlags.EnableStatsHeader;
    private int _userId;

    private IEnumerable<Winner> FilteredWinners => _activeFilter switch
    {
        FilterType.Owned => _winners.Where(w => w.IsOwned),
        FilterType.NotOwned => _winners.Where(w => !w.IsOwned),
        _ => _winners
    };

    private enum FilterType
    {
        All,
        Owned,
        NotOwned
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var winnersArray = await WinnersApi.GetAllWinnersAsync();
            _winners = winnersArray.ToList();
            Logger.LogInformation("Loaded {Count} winners", _winners.Count);
        }
        catch (Exception)
        {
            // Handle error - could log or show user message
            _winners = [];
            Logger.LogError("Failed to load winners");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Initialize user ID from local storage
        await GetUserId();
        StateHasChanged();
    }

    private async Task GetUserId()
    {
        try
        {
            var userIdString = await JsRuntime.InvokeAsync<string>("localStorage.getItem", "userId");
            if (!string.IsNullOrEmpty(userIdString) && int.TryParse(userIdString, out var parsedUserId))
            {
                _userId = parsedUserId;
                Logger.LogInformation("Retrieved user ID from local storage: {UserId}", _userId);
            }
            else
            {
                // Generate a new user ID if none exists
                _userId = 1;
                await JsRuntime.InvokeVoidAsync("localStorage.setItem", "userId", _userId.ToString());
                Logger.LogInformation("Generated new user ID: {UserId}", _userId);
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to retrieve user ID from local storage, using default");
            _userId = 1; // fallback user ID
        }
    }

    private void OnOwnershipChanged(Winner car)
    {
        var index = _winners.FindIndex(c => c.Year == car.Year);
        Logger.LogDebug("Updated ownership for {Year} {Model}", car.Year, car.Model);
        if (index != -1)
        {
            _winners[index] = car;
            StateHasChanged();
        }
    }

    private void SetFilter(FilterType filterType)
    {
        _activeFilter = filterType;
        StateHasChanged();
    }

}
